---
title: "Биостатистика. ДЗ_4"
author: "Тарвидс Эдгарс"
date: "2024-04-03"
output: html_document
---

```{r}
# активация необходимых библиотек
library(ggplot2)
library(tidyverse)
library(car)
```


**Задание 1. Стат-анализ эффективности нового препарата от гипертонии по сравнению со стандартной терапией.**
```{r}
set.seed(30)  # установки воспроизводимости результата
res_before_th <- rnorm(30, 145, 5)  # генерация выборки со среднем 145 и ст. отклонением 5
res_after_th <- rnorm(30, 123, 5)  # генерация выборки со среднем 123 и ст. отклонением 5
```

```{r}
data <- cbind(res_before_th, res_after_th)  # объединение векторов в табличный вид
```


```{r}
# гистограмма для распределения показателей артериального давления до терапии нового лекарства
ggplot(data, aes(x = res_before_th)) + geom_histogram(fill = 'red', color = 'black')  
```
```{r}
shapiro.test(res_before_th)  # применим тест на нормальность распределения данных
```
**Вывод:** данные по показателям артериального давления (до новой терапии) распределные нормально, что в некоторой степени показывает гистограмма и подтверждает тест Шапиро-Уилка(p-value > 0.05). То есть относительно этих данных можно применять параметрические стат-тесты.

```{r}
ggplot(data, aes(x = res_after_th)) + geom_histogram(fill = 'red', color = 'black')
```
```{r}
shapiro.test(res_after_th)  # применим тест на нормальность распределения данных
```
**Вывод:** данные по показателям артериального давления (после новой терапии) распределные нормально, что в некоторой степени показывает гистограмма и подтверждает тест Шапиро-Уилка(p-value > 0.05). То есть относительно этих данных можно применять параметрические стат-тесты.


Сформулируем статистические гипотезы:
H0: нет значимых отличий в использовании нового препарата по сравнению со стандартной терапии в лечении гипертонии.
H1: есть значимые отличия в использовании нового препарата по сравнению со стандартной терапии в лечении гипертонии.

Выберем уровень значимости (альфа) равный 0,05.

Для проверки стат-гипотез используем парный t-тест, так как сравниваем количественные данные (показатели систолического давления) на зависимых выборках (пациенты до и после использования новой терапии гипертензии).

```{r}
t_test_hypert <- t.test(res_before_th, res_after_th, paired = TRUE)
t_test_hypert$statistic  # наблюдаемое значение статистики
```
```{r}
crit_value <- qt(1 - 0.05/2, df = length(res_after_th) - 1)
crit_value
```
**Вывод:** по полученным резултатам стат-анализа (p-value<<0.05 и tнабюд > tкрит) можно заключить, что присутствет статистически значимые отличия в показателях систолического давления пациентов до и после приема нового препарата. Ссылаясь на значения артериального давления пациентов до и после новой терапии, можно сделать вывод, что препарат достаточно эффективно снижает АД в случае гипертензии. 

**Задание 2. Стат-анализ заболеваемости раком легких среди курящих и некурящих людей.**

**Часть 1: выборка размером 100 наблюдений.**

```{r}
sample_1 <- rep(c('smoking', 'nonsmoking'), each = 50)  # создадим вектор с повторяющимися статусами (курящий/некурящий)
sample_1
```
```{r}
set.seed(20)  # фиксируем воспроизводимость выборок с биномиальным распределением
smoking_cancer <- rbinom(50, 1, 0.8)  # биномиальное распределние при вероятности рака легких 0.8 для курящих людей
nonsmoking_cancer <- rbinom(50, 1, 0.2)  # биномиальное распределние при вероятности рака легких 0.2 для некурящих людей
```

1: есть рак легких; 0: нет рака легких.

```{r}
cancer_res <- c(smoking_cancer, nonsmoking_cancer)  # объединим сгенерированные данные в один вектор
```


```{r}
data2 <- data.frame(sample_1, cancer_res)  # создадим датафрэйм c информацией о наличии вредной привычки и наличии рака
```

Сформулируем статистические гипотезы:
H0: вероятность заболевания раком легких одинакова для курящих и некурящих людей.
H1: вероятность заболевания раком легких у курящих и некурящих людей отличается.
Установим уровень значимости (альфа) равный 0.05.

Для проверки стат-гипотез используем тест хи-квадрат Пирсона, так как анализируются категориальные переменные (вредная привычка - болезнь). В силу того, что выборка достаточно большая (100 наблюдений суммарно), то предпочтительно использование именно стат-критерия Пирсона, а не Фишера.

```{r}
cont_table_100 <- table(data2$sample_1, data2$cancer_res)  # создадим таблицу сопряжнности
cont_table_100
```
```{r}
chi_test_lung1 <- chisq.test(cont_table_100)
```

```{r}
chi_test_lung1$statistic  # наблюдаемое значение статистики
```
Так как таблица сопряженности имеет размер 2*2, то число степеней свободы (df = 1).
```{r}
qchisq(0.05, 1, lower.tail = F)  # критическое значение хи-квадрата Пирсона
```

**Вывод:** для выборки размером 100 наблюдений выявлена статистически значимая взаимосвязь между наличием вредной привычки (курением) и вероятностью рака легких, так как рассчитанное p-value<<0.05 наблюдаемое значение хи-квадрата больше критического. Соответственно, можно заключить, что курение повышает вероятность развития рака легких.

**Часть 2: выборка размером 30 наблюдений.**

```{r}
sample_2 <- rep(c('smoking', 'nonsmoking'), each = 15)  # создадим вектор с повторяющимися статусами (курящий/некурящий)
sample_2
```

```{r}
set.seed(13)  # фиксируем воспроизводимость выборок с биномиальным распределением
smoking_cancer_2 <- rbinom(15, 1, 0.8)  # биномиальное распределние при вероятности рака легких 0.8 для курящих людей
nonsmoking_cancer_2 <- rbinom(15, 1, 0.2)  # биномиальное распределние при вероятности рака легких 0.2 для некурящих людей
```

1: есть рак легких; 0: нет рака легких.

```{r}
cancer_res_2 <- c(smoking_cancer_2, nonsmoking_cancer_2)  # объединим сгенерированные данные в один вектор
```

```{r}
data3 <- data.frame(sample_2, cancer_res_2)  # создадим датафрэйм c информацией о наличии вредной привычки и налчии рака
```

Сформулируем статистические гипотезы:
H0: вероятность заболевания раком легких одинакова для курящих и некурящих людей.
H1: вероятность заболевания раком легких у курящих и некурящих людей отличается.
Установим уровень значимости (альфа) равный 0.05.

Для проверки стат-гипотез используем точный критерий Фишера, так как анализируются категорилаьные переменные (вредная привычка - болезнь). В силу того, что выборка достаточно маленькая (30 наблюдений суммарно), то предпочтительно использование именно стат-критерия Фишера, а не Пирсона.

```{r}
cont_table_30 <- table(data3$sample_2, data3$cancer_res_2)  # создадим таблицу сопряжнности
cont_table_30
```
```{r}
fisher_lung1 <- fisher.test(cont_table_30)  # реализация точного критерия Фишера
```

```{r}
fisher_lung1$p.value  # вывод рассчитанного значения p-value
```
**Вывод:** анализ выборки размером 30 наблюдений с помощью точного критерия Фигера показал аналогичные результаты, как и в тестировании крупной выборки с применением критерия Пирсона. Так как p-value<<0.05, можно отвергнуть нулевую гипотезу и принять предположение о наличии взаимосвязи курения и развития рака легкого.

Результаты стат-тестов, полученные в 1-ой и 2-ой частях задания 2, согласуются с известными медицинскими исследованиями. Поэтому выбор и подход к использованию стат-тестов можно признать корректным.


**Задание 3. Стат-анализ эффективности нового метода лечения синдрома раздраженного кишечника.**

Уровень боли является количественной переменной и определяется в интервале 0-10 (0: нет боли, 10: сильная боль).
В рамках этой задачи рассмотрим нормальное распределение показателей уровня боли у двух независимых выборок; первая выборка - лечение диетотерапией, вторая выборка - новый метод лечения.

```{r}
set.seed(56)  # фиксируем воспроизводимость выборок
size <- 50  # размер выборки
diet_met <- round(rnorm(size, 7, 1))  # генерация нормально распределенной выборки для диетотерапии
new_met <- round(rnorm(size, 5, 1))  # генерация нормально распределенной выборки для нового метода лечения
```

```{r}
data4 <- data.frame(diet_met, new_met)  # оформим сгенерированные данные для 2-х выборок в датафрэйм
```
```{r}
data4$diet_met <- as.integer(data4$diet_met)
data4$new_met <- as.integer(data4$new_met)
```

Сформулируем статистические гипотезы:
H0: уровень боли в случае следования диетотерапии и нового метода лечения значимо не отличается.
H1: уровень боли в случае следования диетотерапии и нового метода лечения значимо отличается.
Уровень значимости (альфа) установим 0,05.


```{r}
# классифицируем больных по категории боли (средняя, высокая и т.д.) после диетотерапии
for (i in 1:50){
  if (data4$diet_met[i] == 0){
      data4$pain1[i] <- 'no pain'
  } else if (data4$diet_met[i] > 5){
      data4$pain1[i] <- 'high pain'
  } else if (data4$diet_met[i] > 0 & data4$diet_met[i] <= 5) {
      data4$pain1[i] <- 'medium pain'
  } 
}
```


```{r}
# классифицируем больных по категории боли (средняя, высокая и т.д.) после нового метода лечения
for (i in 1:50){
  if (data4$new_met[i] == 0){
      data4$pain3[i] <- 'no pain'
  } else if (data4$new_met[i] > 5){
      data4$pain3[i] <- 'high pain'
  } else if (data4$new_met[i] > 0 & data4$new_met[i] <= 5) {
      data4$pain3[i] <- 'medium pain'
  }
}
```

```{r}
# количество пациентов с определенной выраженностью боли после диетотерапии
cont_pain1 <- table(data4$pain1)
cont_pain1
```

```{r}
# количество пациентов с определенной выраженностью боли после новой методики лечения
cont_pain3 <- table(data4$pain3)
cont_pain3
```
```{r}
ggplot(data4, aes(diet_met)) + geom_histogram()  # гистограмма распределения показателей боли после диетотерапии
```


```{r}
shapiro.test(data4$diet_met)  # тест на нормальность распределния показателей боли после диетотерапии
```
```{r}
ggplot(data4, aes(new_met)) + geom_histogram()  # гистограмма распределения показателей боли после новой методики
```


```{r}
shapiro.test(data4$new_met)  # тест на нормальность распределния показателей боли после новой методики
```
Так как тест на нормальность (p-value<<0.05) и графический анализ (по гистограммам) показали, что распределение не соответствует нормальному, выбираем для анализа выборок тест Манна-Уитни (U-критерий).

```{r}
wilc_res <- wilcox.test(data4$diet_met, data4$new_met)  # реализация теста Манна-Уитни
```

```{r}
wilc_res$p.value  # вывод p-value
```


```{r}
wilc_res$statistic  # вывод наблюдаемого значения статистики
```
Критическое значение U-критерия найдем по ссылке (альфа = 0,05, размер выборок (n1, n2) 50):
https://cito-web.yspu.org/link1/metod/met125/node44.html

Uкрит. = 1010

**Вывод**: статистический анализ с использованием U-критерия подтвердил альтернативную гипотезу (p-value<<0.05) и статистическую значимость (Uнабл > Uкрит) между показателями уровня боли в двух выборках. По полученным таблицам сопряженности можно заключить, что новая методика лечения снижает уровень боли у пациентов и является эффективной в нивелировании симптомов и лечении синдрома разраженного кишечника.


**Задание 4. Стат-анализ эффективности противоопухолевых препаратов.**

```{r}
set.seed(20)  # установим воспроизводимость генерации данных
tumor <- tibble(  # генерация данных по размерам опухоли в зависимости от типа терапии
  therapy = c(rep("0", 10), rep("A", 10), rep("B", 10)),
  value = c(rep(3213, 10), rep(2687, 10), rep(2423, 10))
) %>%
  mutate(therapy = factor(therapy, levels = c("0", "A", "B")))
tumor$value <- tumor$value + rnorm(30, 0, 760)

```


```{r}
ggplot(tumor, aes(therapy, value, fill = therapy)) + geom_boxplot()  # графическое представление сгенерированных данных
```
```{r}
# проверка на нормальность распределения данных по размеру опухоли при терапии 0
shapiro.test(tumor$value[tumor$therapy == 0])  
```
```{r}
# проверка на нормальность распределения данных по размеру опухоли при терапии А
shapiro.test(tumor$value[tumor$therapy == 'A'])
```
```{r}
# проверка на нормальность распределения данных по размеру опухоли при терапии B
shapiro.test(tumor$value[tumor$therapy == 'B'])
```

```{r}
leveneTest(value ~ therapy, tumor)  # тест на гомогенность дисперсий
```
Так как данные по размерам опухоли для каждого варианта терапии распределены нормально (Шапиро-Уилка тест, p-value>0.05), а дисперсии в подгруппах одинаковы (тест Левена, p-value), допустимо использование дисперсионного анализа (ANOVA).

Сформулируем статистические гипотезы, которые будем проверять в ходе дисперсионного анализа:
H0: размер опухоли не зависит от типа терапии.
H1: размер опухоли зависит от типа терапии.

Установим уровень значимости, равный 0,05.

```{r}
aov_model <- aov(value ~ therapy, tumor)  # реализация дисперсионного анализа
```


```{r}
summary(aov_model)  # обзор стат-результатов
```
**Вывод:** результаты дисперсионного анализа показали, что существует статистически значимое отличие в размере опухоли в зависимости от варианта терапии (p < 0.05, отколняем нулевую гипотезу). Однако ANOVA не уточняет, между какими конкретно вариантами терапии существуют значимые отличия, поэтому необходимо дополнительно исследование с множественными попарными сравнениями.

```{r}
TukeyHSD(aov_model, conf.level = .95)  # реализация множественного попарного сравнения с помощью критерия Тьюки
```
```{r}
plot(TukeyHSD(aov_model, conf.level = .95))  # визуализация результатов попарных сравнения
```
**Вывод:** выполнено три попарных сранения, в одном из рассмотренных случаев выявлено статистически значимое отличие (терапии B-O, p-value<0,05). При анализе пар A-0 и B-A статистически значимый отличий не обнаружено, так как p-value > 0.05.
Графический анализ так же подтвердил наличие отличий в терапиях B и 0, так как дельта (разность) значений опухолей мозга при данных вариантам лечения не входит в нулевой интервал, что, однако, наблдается в парах A-O и B-A.


